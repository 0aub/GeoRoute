# GeoRoute Fixes Applied (2026-01-20)

## ✅ Fixed Issues

### 1. Backlog Page Error (FIXED)
**Problem**: `Cannot read properties of undefined (reading 'terrain_samples')`

**Root Cause**: The `TacticalPlanResponse` model was updated to remove `metadata` field and add required fields like `timestamp`, `recommended_route_id`, `mission_assessment`, etc. The backlog UI component was still trying to access the old `metadata.terrain_samples` field.

**Fix Applied**:
- Updated `BacklogCard.tsx` to use the new response structure
- Replaced metadata display with: request_id, total_duration, api_calls, recommended_route, mission_assessment, timestamp

**Files Modified**:
- `/ui/src/components/backlog/BacklogCard.tsx` (lines 153-181)

**Status**: ✅ WORKING - Backlog page now displays correctly

---

### 2. Google Maps Walking Routes API (PREPARED)
**Problem**: Routes generated by Gemini AI are unrealistic and don't respect real-world obstacles (buildings, walls, etc.)

**Solution Prepared**:
- Added `get_walking_routes()` method to Google Maps client
- Uses `mode="walking"` with `alternatives=true` to get 3 real walking routes
- Extracts actual walkable waypoints from Google Maps Directions API

**Files Modified**:
- `/georoute/clients/google_maps.py` (lines 176-242) - Added walking routes method

**What the walking routes method does**:
1. Calls Google Maps Directions API with `mode=walking`
2. Requests alternative routes (up to 3 routes)
3. Extracts waypoints from actual walking steps
4. Returns realistic paths that avoid buildings and respect obstacles
5. Includes distance and duration for each route

**Status**: ⚠️ API METHOD READY - But pipeline needs to be updated to use it

---

## ⚠️ Next Steps Required

### Integrate Walking Routes into Tactical Pipeline

**What needs to change**:

Currently, the system works like this:
```
1. Gemini generates arbitrary waypoints (UNREALISTIC)
2. Gemini refines waypoints with risk assessment
3. Gemini scores routes
4. Gemini classifies routes
```

It should work like this:
```
1. Google Maps generates 3 REAL walking routes (REALISTIC)
2. Add elevation data to waypoints
3. Gemini assesses RISK ONLY for each waypoint
4. Gemini scores routes based on risk
5. Gemini classifies routes
```

**File to modify**: `/georoute/processing/tactical_pipeline.py`

**Required changes in `plan_tactical_attack()` method**:

1. **Calculate tactical objective** (lines 277-285):
   ```python
   # Calculate start position (average of soldier positions)
   start_lat = sum(s.lat for s in request.soldiers) / len(request.soldiers)
   start_lon = sum(s.lon for s in request.soldiers) / len(request.soldiers)

   # Calculate target position (average of enemy positions)
   target_lat = sum(e.lat for e in request.enemies) / len(request.enemies)
   target_lon = sum(e.lon for e in request.enemies) / len(request.enemies)
   ```

2. **Get realistic walking routes** (replace stage1):
   ```python
   # Get 3 alternative walking routes from Google Maps
   walking_routes = await self.gmaps.get_walking_routes(
       origin=(start_lat, start_lon),
       destination=(target_lat, target_lon)
   )

   # Log the API call
   self._log_api_call(
       api_name="google_maps",
       endpoint="directions_walking",
       request_params={"origin": [start_lat, start_lon], "destination": [target_lat, target_lon]},
       response_data={"routes_count": len(walking_routes)},
   )
   ```

3. **Add elevation to waypoints** (replace stage2):
   ```python
   for route in walking_routes:
       # Extract waypoint coordinates
       coords = [(wp["lat"], wp["lon"]) for wp in route["waypoints"]]

       # Get elevation data
       elevation_result = await self.gmaps.get_elevation_at_points(coords)

       # Merge elevation into waypoints
       if elevation_result.get("success"):
           for wp, elev_data in zip(route["waypoints"], elevation_result["elevations"]):
               wp["elevation_m"] = elev_data["elevation_m"]
   ```

4. **Update Gemini prompts** to only assess risk:
   - Stage 1: Skip (replaced by Google Maps)
   - Stage 2: Change to "Assess tactical risk for each waypoint" (don't generate waypoints)
   - Stage 3: Keep scoring logic
   - Stage 4: Keep classification

**Benefits**:
- ✅ Routes respect buildings, walls, and obstacles
- ✅ Routes follow actual walkable paths
- ✅ Routes use real sidewalks and streets
- ✅ No arbitrary waypoints in inaccessible areas
- ✅ Gemini focuses on what it's good at: risk assessment

---

## Summary

### Fixed (Deployed):
1. ✅ Backlog page error - Now working
2. ✅ Google Maps walking API - Method ready

### Needs Implementation:
1. ⚠️ Update tactical pipeline to use walking routes
2. ⚠️ Modify Gemini prompts to only assess risk (not generate waypoints)
3. ⚠️ Test with real tactical scenarios

### Expected Result:
Routes will follow actual walkable paths and respect real-world obstacles, making the tactical planning realistic and usable.

---

## Testing the Fix

Once the pipeline is updated, test with:
```bash
# Place 1 soldier at (30.16, 47.49)
# Place 1 enemy at (30.17, 47.50)
# Click "Plan Tactical Attack"
```

You should see:
- 3 routes that follow actual paths/roads
- Waypoints that avoid buildings
- Realistic walking distances and times
- Risk assessments based on real paths

---

## ⚠️ ACTION REQUIRED: Enable Google Routes API

### Issue Found
The system cannot use Google Maps for walking routes because:
1. **Legacy Directions API** - Deprecated by Google, returns `REQUEST_DENIED`
2. **Routes API v2** - Not enabled in Google Cloud project

### Error Message
```
Routes API has not been used in project 82027544315 before or it is disabled.
```

### Solution
**Enable the Routes API** by visiting:
https://console.developers.google.com/apis/api/routes.googleapis.com/overview?project=82027544315

### What I Updated
- ✅ Updated `get_walking_routes()` to use Routes API v2 (POST endpoint)
- ✅ Uses proper request format with lat/lng objects
- ✅ Handles v2 response format (distanceMeters, duration strings)
- ✅ Extracts waypoints from step locations

### Once Routes API is Enabled
After enabling the API and waiting ~5 minutes for propagation:
1. The system will generate 3 realistic walking routes
2. Routes will follow actual sidewalks and paths
3. Routes will respect buildings and obstacles
4. Gemini will only assess tactical risk (not generate waypoints)

### Current Status
- ✅ Code is ready and updated for Routes API v2
- ⚠️ **Waiting for Routes API to be enabled in Google Cloud Console**
- ⚠️ System currently falls back to Gemini-generated routes

**Note**: Until the Routes API is enabled, the system uses Gemini-generated waypoints which may not respect real-world obstacles.
